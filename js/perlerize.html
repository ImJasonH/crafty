<html>
<head><style>
#file {
	width: 100%;
	height: 400px;
	border: 1px dashed black;
}
</style></head>
<body>
	<table id="table" style="display: none;">
		<tr><td>Original</td><td><canvas id="orig" width=0 height=0></canvas></td></tr>
	  <tr><td>Out</td><td><canvas id="out" width=0 height=0></canvas></td>
		  <td><button id="save">Save</button></td></tr>
	</table>
  <input type="file" id="file" accept="image/png"></input>
</body>
<script type="text/javascript">
var palette = [
    [0,0,0],
    [255,0,0],
    [0,255,0],
    [0,0,255],
    [255,255,255]
    ];

function select(e) {
	var files = e.target.files || e.dataTransfer.files;
  var file = files[0];
  var orig = document.getElementById('orig');
  var origCtx = orig.getContext('2d');
	var out = document.getElementById('out');
	var outCtx = out.getContext('2d');
  var reader = new FileReader();
  reader.onload = function(e){
    var img = new Image();
    img.src = e.target.result;
    orig.width = img.width;
    orig.height = img.height;
    origCtx.drawImage(img, 0, 0);
		out.width = img.width;
		out.height = img.height;

    var imgd = origCtx.getImageData(0,0,img.width,img.height);
    var pix = imgd.data;
    var map = {};
		closestMap = {};
    for (var i = 0, n = pix.length; i < n; i += 4) {
      var r = pix[i  ] * pix[i+3]/255;
      var g = pix[i+1] * pix[i+3]/255;
      var b = pix[i+2] * pix[i+3]/255;
			if (pix[i+3] == 0) {
				// transparent
				continue;
			}

      var cl = closest([r,g,b]);
      if (cl in map) { map[cl]++; } else { map[cl] = 1; }

      pix[i  ] = cl[0];
      pix[i+1] = cl[1];
      pix[i+2] = cl[2];
    }
    outCtx.putImageData(imgd,0,0);
    console.log(map);
  };
  reader.readAsDataURL(file);
  document.getElementById('table').style.display = '';
};

document.getElementById('file').onchange = select;

document.getElementById('save').onclick = function(e) {
  window.open(document.getElementById('out').toDataURL());
};

// color is a three-element array
var closestMap = {};
function closest(color) {
  if (color in closestMap) { return closestMap[color]; }
  var closest = null;
  var dist = Infinity;
  for (var i = 0; i < palette.length; i++) {
    var c = palette[i];
    if (color == c) { return c; }
    var d = distance(c, color);
    if (closest == null || d < dist) {
      closest = c;
      dist = d;
    }
  }
  closestMap[color] = closest;
  return closest;
}

function distance(a, b) {
  return Math.pow(Math.abs(a[0]-b[0]), 2) +
      Math.pow(Math.abs(a[1]-b[1]), 2) +
      Math.pow(Math.abs(a[2]-b[2]), 2);
}

function hex(color) {
  return '#' + color[0].toString(16) +
      color[1].toString(16) +
      color[2].toString(16);
}
</script>
</html>